syntax = "proto3";

package task;

option go_package = "github.com/yuisofull/goload/internal/task/pb;pb";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

service TaskService {
  rpc CreateTask(CreateTaskRequest) returns (TaskResponse);
  rpc GetTask(GetTaskRequest) returns (TaskResponse);
  rpc ListTasks(ListTasksRequest) returns (ListTasksResponse);
  rpc DeleteTask(DeleteTaskRequest) returns (DeleteTaskResponse);
  rpc PauseTask(PauseTaskRequest) returns (PauseTaskResponse);
  rpc ResumeTask(ResumeTaskRequest) returns (ResumeTaskResponse);
  rpc CancelTask(CancelTaskRequest) returns (CancelTaskResponse);
  rpc RetryTask(RetryTaskRequest) returns (RetryTaskResponse);
  rpc UpdateTaskStoragePath(UpdateTaskStoragePathRequest) returns (UpdateTaskResponse);
  rpc UpdateTaskStatus(UpdateTaskStatusRequest) returns (UpdateTaskResponse);
  rpc UpdateTaskProgress(UpdateTaskProgressRequest) returns (UpdateTaskResponse);
  rpc UpdateTaskError(UpdateTaskErrorRequest) returns (UpdateTaskResponse);
  rpc UpdateTaskChecksum(UpdateTaskChecksumRequest) returns (UpdateTaskResponse);
  rpc UpdateTaskMetadata(UpdateTaskMetadataRequest) returns (UpdateTaskResponse);
  rpc CompleteTask(CompleteTaskRequest) returns (UpdateTaskResponse);
  rpc CheckFileExists(CheckFileExistsRequest) returns (CheckFileExistsResponse);
  rpc GetTaskProgress(GetTaskProgressRequest) returns (GetTaskProgressResponse);
}

message Task {
  uint64 id = 1;
  uint64 of_account_id = 2;
  string file_name = 3;
  string source_url = 4;
  SourceType source_type = 5;
  AuthConfig source_auth = 6;
  StorageType storage_type = 7;
  string storage_path = 8;
  ChecksumInfo checksum = 9;
  DownloadOptions download_options = 10;
  TaskStatus status = 11;
  DownloadProgress progress = 12;
  string error_message = 13;
  google.protobuf.Struct metadata = 14;
  google.protobuf.Timestamp created_at = 15;
  google.protobuf.Timestamp updated_at = 16;
  google.protobuf.Timestamp completed_at = 17;
}

message DownloadProgress {
  double progress = 1;
  int64 downloaded_bytes = 2;
  int64 total_bytes = 3;
}

message DownloadOptions {
  int32 concurrency = 1;
  int64 max_speed = 2;
  int32 max_retries = 3;
  int32 timeout = 4;
}

message AuthConfig {
  string type = 1;
  string username = 2;
  string password = 3;
  string token = 4;
  map<string, string> headers = 5;
}

message ChecksumInfo {
  string checksum_type = 1;
  string checksum_value = 2;
}

message TaskFilter {
  uint64 of_account_id = 1;
  repeated TaskStatus status = 2;
  repeated string tags = 3;
  repeated SourceType source_type = 4;
  TimeRange created_at = 5;
  string search = 6;
}

message TimeRange {
  google.protobuf.Timestamp from = 1;
  google.protobuf.Timestamp to = 2;
}

message GetTaskRequest {
  uint64 id = 1;
}

message CreateTaskRequest {
  uint64 of_account_id = 1;
  string file_name = 2;
  string source_url = 3;
  SourceType source_type = 4;
  AuthConfig source_auth = 5;
  ChecksumInfo checksum = 6;
  DownloadOptions download_options = 7;
  google.protobuf.Struct metadata = 8;
}

message UpdateTaskRequest {
  uint64 task_id = 1;
  TaskStatus status = 2;
  DownloadProgress progress = 3;
  string error = 4;
  ChecksumInfo checksum = 5;
}

message ListTasksRequest {
  TaskFilter filter = 1;
  int32 offset = 2;
  int32 limit = 3;
  string sort_by = 4;
  bool sort_asc = 5;
}

message ListTasksResponse {
  repeated Task tasks = 1;
  int32 total = 2;
}

message PauseTaskRequest {
  uint64 id = 1;
  uint64 of_account_id = 2;
}

message TaskResponse {
  Task task = 1;
}

enum SourceType {
  HTTP = 0;
  HTTPS = 1;
  FTP = 2;
  SFTP = 3;
  BITTORRENT = 4;
}

enum StorageType {
  LOCAL = 0;
  MINIO = 1;
  S3 = 2;
}

enum TaskStatus {
  PENDING = 0;
  DOWNLOADING = 1;
  STORING = 2;
  COMPLETED = 3;
  FAILED = 4;
  CANCELLED = 5;
  PAUSED = 6;
}

message DeleteTaskRequest {
  uint64 id = 1;
}

message DeleteTaskResponse {
  string message = 1;
}

message PauseTaskResponse {
  string message = 1;
}

message ResumeTaskRequest {
  uint64 id = 1;
}

message ResumeTaskResponse {
  string message = 1;
}

message CancelTaskRequest {
  uint64 id = 1;
}

message CancelTaskResponse {
  string message = 1;
}

message RetryTaskRequest {
  uint64 id = 1;
}

message RetryTaskResponse {
  string message = 1;
}

message UpdateTaskStoragePathRequest {
  uint64 id = 1;
  string storage_path = 2;
}

message UpdateTaskStatusRequest {
  uint64 id = 1;
  TaskStatus status = 2;
}

message UpdateTaskProgressRequest {
  uint64 id = 1;
  DownloadProgress progress = 2;
}

message UpdateTaskErrorRequest {
  uint64 id = 1;
  string error = 2;
}
message UpdateTaskChecksumRequest {
  uint64 id = 1;
  ChecksumInfo checksum = 2;
}

message UpdateTaskMetadataRequest {
  uint64 id = 1;
  google.protobuf.Struct metadata = 2;
}

message UpdateTaskResponse {
}

message CompleteTaskRequest {
  uint64 id = 1;
}

message CheckFileExistsRequest {
  uint64 task_id = 1;
}

message CheckFileExistsResponse {
  bool exists = 1;
}

message GetTaskProgressRequest {
  uint64 task_id = 1;
}

message GetTaskProgressResponse {
  DownloadProgress progress = 1;
}
